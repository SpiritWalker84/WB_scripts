#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ï–¥–∏–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ —Ü–µ–Ω –Ω–∞ Wildberries
–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:
1. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Å WB
2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤ –∏ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
"""

import sys
from pathlib import Path
from typing import Optional
import traceback
import time

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
try:
    from clear_wb_stocks import clear_all_stocks
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ clear_wb_stocks: {e}")
    sys.exit(1)

try:
    from download_price import main as download_price_main
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ download_price: {e}")
    sys.exit(1)

try:
    from update_wb_stocks_prices import main as update_stocks_prices_main
except ImportError as e:
    print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ update_wb_stocks_prices: {e}")
    sys.exit(1)


def run_step(step_num: int, step_name: str, step_func, *args, **kwargs) -> bool:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —à–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    
    Args:
        step_num: –ù–æ–º–µ—Ä —à–∞–≥–∞
        step_name: –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞
        step_func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        
    Returns:
        bool: True –µ—Å–ª–∏ —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
    """
    print("\n" + "=" * 60)
    print(f"–®–ê–ì {step_num}: {step_name}")
    print("=" * 60)
    
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π sys.exit –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
        original_exit = sys.exit
        
        def custom_exit(code=0):
            """–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç sys.exit –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ"""
            if code != 0:
                raise SystemExit(code)
        
        sys.exit = custom_exit
        
        try:
            if args or kwargs:
                step_func(*args, **kwargs)
            else:
                step_func()
            print(f"\n‚úì –®–∞–≥ {step_num} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ")
            return True
        finally:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π sys.exit
            sys.exit = original_exit
            
    except KeyboardInterrupt:
        print(f"\n‚ö† –®–∞–≥ {step_num} –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        return False
    except SystemExit as e:
        if e.code != 0:
            print(f"\n‚úó –®–∞–≥ {step_num} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: {e.code})")
            return False
        return True
    except Exception as e:
        print(f"\n‚úó –û—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ {step_num}: {e}")
        print("\n–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
        traceback.print_exc()
        return False


def run_step_with_retry(step_num: int, step_name: str, step_func, max_retries: int = 3, 
                        retry_delay: int = 10, *args, **kwargs) -> bool:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —à–∞–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    
    Args:
        step_num: –ù–æ–º–µ—Ä —à–∞–≥–∞
        step_name: –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞
        step_func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–≤—É—é)
        retry_delay: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        
    Returns:
        bool: True –µ—Å–ª–∏ —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
    """
    for attempt in range(1, max_retries + 1):
        if attempt > 1:
            print(f"\nüîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt} –∏–∑ {max_retries} –¥–ª—è —à–∞–≥–∞ {step_num}...")
            print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {retry_delay} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
            time.sleep(retry_delay)
        
        success = run_step(step_num, step_name, step_func, *args, **kwargs)
        
        if success:
            if attempt > 1:
                print(f"\n‚úì –®–∞–≥ {step_num} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ {attempt} –ø–æ–ø—ã—Ç–æ–∫")
            return True
        else:
            if attempt < max_retries:
                print(f"\n‚ö† –®–∞–≥ {step_num} –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω, –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
            else:
                print(f"\n‚úó –®–∞–≥ {step_num} –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫")
    
    return False


def main() -> None:
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
    print("=" * 60)
    print("–ü–û–õ–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–°–¢–ê–¢–ö–û–í –ò –¶–ï–ù –ù–ê WILDBERRIES")
    print("=" * 60)
    print("\n–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:")
    print("  1. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Å Wildberries")
    print("  2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤ –∏–∑ –ø–æ—á—Ç—ã –∏ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º")
    print("  3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ Wildberries")
    print("\n–ö–∞–∂–¥—ã–π —à–∞–≥ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω –¥–æ 3 —Ä–∞–∑ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö")
    print("=" * 60)
    
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤
    step_results = {
        1: False,  # –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
        2: False,  # –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤
        3: False   # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
    }
    
    # –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
    step_results[1] = run_step_with_retry(
        1, 
        "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Å Wildberries", 
        clear_all_stocks,
        max_retries=3,
        retry_delay=10
    )
    
    if not step_results[1]:
        print("\n‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –®–∞–≥ 1 (—É–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤) –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")
        print("‚ö† –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º...")
    
    # –ó–∞–¥–µ—Ä–∂–∫–∞ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
    print("\n‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤...")
    time.sleep(30)
    
    # –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤
    step_results[2] = run_step_with_retry(
        2, 
        "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤ –∏ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º", 
        download_price_main,
        max_retries=3,
        retry_delay=15
    )
    
    if not step_results[2]:
        print("\n‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –®–∞–≥ 2 (–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤) –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")
        if step_results[1]:
            print("\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø!")
            print("üö® –û—Å—Ç–∞—Ç–∫–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –Ω–æ–≤—ã–µ –ø—Ä–∞–π—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
            print("üö® –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ—Å—Ç–∞—Ç–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ 0 –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!")
        print("‚ö† –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞...")
    
    # –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
    step_results[3] = run_step_with_retry(
        3, 
        "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤", 
        update_stocks_prices_main,
        max_retries=3,
        retry_delay=15
    )
    
    if not step_results[3]:
        print("\n‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –®–∞–≥ 3 (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤) –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")
        if step_results[1] and not step_results[2]:
            print("\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø!")
            print("üö® –û—Å—Ç–∞—Ç–∫–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –Ω–µ –±—ã–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
            print("üö® –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å—Ä–æ—á–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é!")
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —à–∞–≥–æ–≤
    print("\n" + "=" * 60)
    print("–ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢")
    print("=" * 60)
    
    all_success = all(step_results.values())
    
    if all_success:
        print("‚úì –í–°–ï –®–ê–ì–ò –í–´–ü–û–õ–ù–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("\n–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω:")
        print("  ‚úì –û—Å—Ç–∞—Ç–∫–∏ —É–¥–∞–ª–µ–Ω—ã")
        print("  ‚úì –ü—Ä–∞–π—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ —Ä–∞–∑–±–∏—Ç—ã –ø–æ –±—Ä–µ–Ω–¥–∞–º")
        print("  ‚úì –¶–µ–Ω—ã –∏ –æ—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ Wildberries")
    else:
        print("‚ö† –ü–†–û–¶–ï–°–° –ó–ê–í–ï–†–®–ï–ù –° –û–®–ò–ë–ö–ê–ú–ò!")
        print("\n–°—Ç–∞—Ç—É—Å —à–∞–≥–æ–≤:")
        print(f"  {'‚úì' if step_results[1] else '‚úó'} –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤")
        print(f"  {'‚úì' if step_results[2] else '‚úó'} –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–æ–≤")
        print(f"  {'‚úì' if step_results[3] else '‚úó'} –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤")
        
        if step_results[1] and not (step_results[2] and step_results[3]):
            print("\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:")
            print("üö® –û—Å—Ç–∞—Ç–∫–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –Ω–µ –±—ã–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
            print("üö® –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é!")
            print("üö® –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤!")
        
        sys.exit(1)  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö† –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(1)
    except Exception as e:
        print(f"\n\n‚úó –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        traceback.print_exc()
        sys.exit(1)

